# exploit

- Require of lab:

> + This website has an insecure CORS configuration in that it trusts all subdomains regardless of the protocol.
> 
> 
> + You can log in to your own account using the following credentials: wiener:peter
> 
- Goal:
    
    + To solve the lab, craft some JavaScript that uses CORS to retrieve the administrator's API key and upload the code to your exploit server. The lab is solved when you successfully submit the administrator's API key..
    
- Steps:
- Analysis:
    
    +  I log in with the credentials provided and see the API key of wiener on the My account page.
    
    Looking in the HTML source, I see a JavaScript call to obtain this key:
    
    ![exploit%206d6bb8f640e34de18a0a421d70fb55a1/image1.png](exploit%206d6bb8f640e34de18a0a421d70fb55a1/image1.png)
    
    + This results in this request being made:
    
    ![exploit%206d6bb8f640e34de18a0a421d70fb55a1/image2.png](exploit%206d6bb8f640e34de18a0a421d70fb55a1/image2.png)
    
- Naive attempts
    
    + So as a first attempt I try to craft a JavaScript snippet that sends a request to the account details and tries to access the response data:
    
    ![exploit%206d6bb8f640e34de18a0a421d70fb55a1/image3.png](exploit%206d6bb8f640e34de18a0a421d70fb55a1/image3.png)
    
    + The request is issued as expected and the response contains the desired API key:
    
    ![exploit%206d6bb8f640e34de18a0a421d70fb55a1/image4.png](exploit%206d6bb8f640e34de18a0a421d70fb55a1/image4.png)
    
    + However, it does not contain an Access-Control-Allow-Origin header. As a result, the browser does not have the permission to allow a script on running from http://exploit... to access the data received from [https://...web-security-academy.net](https://...web-security-academy.net/)
    
- Find a way to execute scripts on an allowed domain
    
    + The next step is to try to find a way to execute my payload within the allowed domain
    
    + For this, I check the shop to find a possible XSS vulnerability. In this lab, with only very few injection points, it is not difficult to find it manually. Burp can help to speed up the process:
    
    ![exploit%206d6bb8f640e34de18a0a421d70fb55a1/image5.png](exploit%206d6bb8f640e34de18a0a421d70fb55a1/image5.png)
    
    + Verifying it manually in the browser by accessing https://stock.ac411fa31f815f5cc0894656004f00b2.web-security-academy.net/?productId=1%3Cscript%3Ealert(document.domain);%3C/script%3E&storeId=1 shows the desired popup:
    
    ![exploit%206d6bb8f640e34de18a0a421d70fb55a1/image6.png](exploit%206d6bb8f640e34de18a0a421d70fb55a1/image6.png)
    
- Putting it together
    
    + After a couple of attempts I got the required modifications and URL encodings correct. Specifically:
    
    + My exploit server is not a trusted location. I need to use document.location to a trusted domain, in this case https://stock.... In this context, I execute my payload via Cross-Site scripting (XSS). As it is a trusted domain the browser allows the script access to the response of /accountDetails.
    
    + The URL for document.location needs to URL-encode the < of the closing script tag. When the browser parses a script, it quits at the first </script> found. In other cases this is the required behaviour, but not here. So I need to ensure the parser does not see it.
    
    + The + and & in the request to my exploit server need to be URL-encoded, otherwise, it will be treated as arguments of the request to https://stock...
    
    + The final scripts looks a bit daunting:
    
    ![exploit%206d6bb8f640e34de18a0a421d70fb55a1/image7.png](exploit%206d6bb8f640e34de18a0a421d70fb55a1/image7.png)
    
    + Testing the exploit shows my API key in the log:
    
    ![exploit%206d6bb8f640e34de18a0a421d70fb55a1/image8.png](exploit%206d6bb8f640e34de18a0a421d70fb55a1/image8.png)
    
- We can find for the victim results in the required API key.