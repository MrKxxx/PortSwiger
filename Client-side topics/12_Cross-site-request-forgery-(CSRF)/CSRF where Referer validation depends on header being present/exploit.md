# exploit

- Require of lab:

> + This lab's email change functionality is vulnerable to CSRF. It attempts to block cross domain requests but has an insecure fallback.
> 
> 
> + You can log in to your own account using the following credentials: wiener:peter
> 
- Goal:
    
    + To solve the lab, use your exploit server to host an HTML page that uses a [CSRF attack](https://portswigger.net/web-security/csrf) to change the viewer's email address.
    
- Steps:
- Find weak CSRF protection:
    
    + I login with the known credentials for wiener and change the email address. This results in the following request:
    
    ![exploit%20f7f61243941640e499675578eae2f77b/image1.png](exploit%20f7f61243941640e499675578eae2f77b/image1.png)
    
    + There is no CSRF-token or any obvious protection visible, sending the request to Repeater and change the email again works without issues
    
    + The first attempt is to use a trivial attack like a lab i did in the previous
    
    ![exploit%20f7f61243941640e499675578eae2f77b/image2.png](exploit%20f7f61243941640e499675578eae2f77b/image2.png)
    
    + The lab name contains the spoiler alert already: It does not work here
    
    ![exploit%20f7f61243941640e499675578eae2f77b/image3.png](exploit%20f7f61243941640e499675578eae2f77b/image3.png)
    
    + Fortunately, the error message gives a clear indication about what might be wrong.
    
    + The referer header is usually added by the browser automatically when a link is followed. In this case, the referer for my malicious form is my exploit server. So the next step is to put this request into Repeater and simply remove the header, and:
    
    ![exploit%20f7f61243941640e499675578eae2f77b/image4.png](exploit%20f7f61243941640e499675578eae2f77b/image4.png)
    
    + The request goes through and the email gets changed. So the only protection that is in place here is the content of the referer. This is a violation of the condition **Validate on every action**.
    
    + Relying on a client provided value is always a bad thing. A malicious actor that is able to intercept the traffic can manipulate it at will.
    
    + While I can modify my own traffic, I do not have the capability for the traffic of my victim. In this case I need to coerce the browser of the victim to not send the header.
    
    + Fortunately, the documentation at [mozilla.org](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy) shoes the answer: Referrer-Policy, specifically:
    
    ![exploit%20f7f61243941640e499675578eae2f77b/image5.png](exploit%20f7f61243941640e499675578eae2f77b/image5.png)
    
    + So I update my exploit page with the relevant header:
    
    ![exploit%20f7f61243941640e499675578eae2f77b/image6.png](exploit%20f7f61243941640e499675578eae2f77b/image6.png)
    
    + This time after viewing the exploit my email address got changed.
    
    + As an alternative, the directive can also be integrated into the HTML code itself:
    
    ![exploit%20f7f61243941640e499675578eae2f77b/image7.png](exploit%20f7f61243941640e499675578eae2f77b/image7.png)
    
- All that is left now is to press Deliver exploit to victim in order to solve the lab.