# exploit

- Required:
    
    + This online shop has a live chat feature implemented using [WebSockets](https://portswigger.net/web-security/websockets).
    
- Goal:
    
    + To solve the lab, use the exploit server to host an HTML/JavaScript payload that uses a [cross-site WebSocket hijacking attack](https://portswigger.net/web-security/websockets/cross-site-websocket-hijacking) to exfiltrate the victim's chat history, then use this gain access to their account.
    
    + Two options exist to exfiltrate the data in the lab:
    
- Using Burp Collaborator, which is part of the Burp Suite Professional
- Using the exploit server access log
- Steps:
- Analysis
    
    + The lab application is a shop website offering chat support. After loading the page, I go straight to the chat feature and start chatting with the agent:
    
    ![exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image1.png](exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image1.png)
    
    + The message exchange runs via WebSockets, with me sending messages to the server and the server sending back whatever needs to be written in the chat on my side:
    
    ![exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image2.png](exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image2.png)
    
    + The next thing is to look at the handshake to see how the WebSocket is established:
    
    ![exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image3.png](exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image3.png)
    
    + There is a single identifying feature in the request, the session cookie, without any protection against CSRF attacks.
    
    + The cookie is automatically sent by the browser. If I create my own web application that utilizes this WebSocket, I can therefore use this connection to perform any action and read any data the victim has access to.
    
    + What is also noteworthy is that once the WebSocket connection is established, the server sends the full history of the chat. This is noticeable on the chat page. No matter how often I reload the page, the full chat history is displayed.
    
    + If I can utilize this connection to retrieve the chat content of my victim, I may be able to find useful information.
    
- **Craft malicious application**
    
    + Let's start the malicious application. The [WebSocket page on javascript.info](https://javascript.info/websocket) provides a good example to follow. The chat always starts with a READY message, so I reproduce this.
    
    ![exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image4.png](exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image4.png)
    
    + Once I open the page, I get my full chat history displayed:
    
    ![exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image5.png](exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image5.png)
    
- Now that I know it works, I can start exfiltrating the data.
- Option 1: Burp Collaborator
    
    + As a first option, I can exfiltrate using the Burp Collaborator. This requires a Burp Suite Professional license but is very convenient. See option 2 below for the non-Burp Pro solution.
    
    ![exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image6.png](exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image6.png)
    
    + I see a lot of errors in the browser console.
    
    + This does not prevent the exfiltration of the chat data as it refers to the connection to the collaborator URL, not the WebSocket. In my Burp Collaborator client, I get all my chat history.
    
    + If I want to get rid of these error messages, the documentation on [mozilla.org](https://developer.mozilla.org/en-US/docs/Web/API/Request/mode) leads to the RequestMode. Setting this to no-cors stops the errors.
    
    + The messages are out of order, but going through the requests the following conversation is visible:
    
    ![exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image7.png](exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image7.png)
    
- Options2: Exploit server log
    
    + As an alternative to Burp Suite Professional, I can also use the Access Log feature of the exploit server. For this, I need to replace the fetch URL with my exploit server:
    
    ![exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image8.png](exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image8.png)
    
    + After delivering the exploit to the victim, the chat contents are visible in the Access log of the exploit server:
    
    ![exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image9.png](exploit%203e8dd26ff76c43f49be8f3b8ae1fd7f8/image9.png)