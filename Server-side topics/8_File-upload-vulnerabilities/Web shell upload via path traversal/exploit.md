# exploit

- Required:
    
    + This lab contains a vulnerable image upload function. The server is configured to prevent execution of user-supplied files, but this restriction can be bypassed by exploiting a [secondary vulnerability](https://portswigger.net/web-security/file-path-traversal).
    

+ You can log in to your own account using the following credentials: wiener:peter

- Goal:
    
    + To solve the lab, upload a basic PHP web shell and use it to exfiltrate the contents of the file /home/carlos/secret. Submit this secret using the button provided in the lab banner.
    
- Steps:
- Analysis:
    
    + The public pages do not show anything of interest, so I login with the provided credentials for wiener.
    
    The account overview allows an upload of the avatar image. A disguise of the file content is not necessary here.
    
    + Upload the shell script
    
    ![exploit%203d249851d6ee4eae8a11d3e322d3d134/image1.png](exploit%203d249851d6ee4eae8a11d3e322d3d134/image1.png)
    
    ![exploit%203d249851d6ee4eae8a11d3e322d3d134/image2.png](exploit%203d249851d6ee4eae8a11d3e322d3d134/image2.png)
    
    + However, accessing this file just shows the content of the file. The PHP code is not executed on the server side:
    
    ![exploit%203d249851d6ee4eae8a11d3e322d3d134/image3.png](exploit%203d249851d6ee4eae8a11d3e322d3d134/image3.png)
    
- Modify the file path
    
    + The definition of what files are executed is often done per directory. The /files/avatar/ path appears not to execute PHP scripts. The next step is to try and escape the path into a location that executes PHP.
    
    + I change the filename to ../shell.php to try to store the file on dictionary up. The upload confirmation shows the same path avatar/ as the previous upload, so the path traversal did not succeed
    
    + Either some or all of the characters of the path traversal are stripped away, or the application is not vulnerable to this type of attack (the lab name gives a hint which one it is).
    
    My first attempt to circumvent the protection is to obfuscate the path traversal with URL-encoding the ../ part:
    
    ![exploit%203d249851d6ee4eae8a11d3e322d3d134/image4.png](exploit%203d249851d6ee4eae8a11d3e322d3d134/image4.png)
    
    ![exploit%203d249851d6ee4eae8a11d3e322d3d134/image5.png](exploit%203d249851d6ee4eae8a11d3e322d3d134/image5.png)
    
    + The response indicates that the path traversal was successful. Accessing the path calls the file outside of the avatar directory and executes the PHP on the server, providing the secret string (calling /files/shell.php shows the same, I just went via the account details page where the image source contains the URL-encoding).
    
    ![exploit%203d249851d6ee4eae8a11d3e322d3d134/image6.png](exploit%203d249851d6ee4eae8a11d3e322d3d134/image6.png)
    
    ![exploit%203d249851d6ee4eae8a11d3e322d3d134/image7.png](exploit%203d249851d6ee4eae8a11d3e322d3d134/image7.png)
    
- We copy it and submit in the tag solution.