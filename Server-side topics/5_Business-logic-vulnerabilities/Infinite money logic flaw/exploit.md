# exploit

- Required:
    
    + This lab has a logic flaw in its purchasing workflow.
    
    + You can log in to your own account using the following credentials: wiener:peter
    
- Goal:
    
    + To solve the lab, exploit this flaw to buy a "Lightweight l33t leather jacket".
    
- Steps:
    
    + The shop itself looks very familiar, but my account page has a new feature - I can use gift cards. Additionally, the lab provides access to my emails.
    
    ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image1.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image1.png)
    
    + The gift cards can be purchased for $10.
    
    ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image2.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image2.png)
    
    + To find out how this works, simply buy one
    
    ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image3.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image3.png)
    
    + On the 'My account' website I can apply the gift card to bring my store credit back up to $100. Unfortunately, I can not apply the gift card a second time. The gift card code can also not be used as a coupon on the checkout page.
    
    Nothing obviously fishy comes up upon checking the requests in Burp.
    
- Subcribing to newsletter

> + The other option for interacting with the page is the newsletter. I subscribe to find out if there is any interesting reward for it
> 
> 
> ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image4.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image4.png)
> 
> + It is a 30% discount. This makes me think... The gift card states $10 flat rate value, can I apply the 30% on this? (after all, all shops I know in real life exclude gift cards explicitly from discounts). After the code is generated and applied to my account, the store credit total shows $3 higher than before:
> 
> ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image5.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image5.png)
> 
- So for $7 I can purchase a $10 gift card that redeems for face value.
- **Purchasing gift cards**

> + For the $103 I have in store credit, I can purchase 14 gift cards, generating a $3 profit each and a total of $42
> 
> 
> ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image6.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image6.png)
> 
- To obtain the $1234 required to purchase the leather jacket, I need to redeem 412 gift cards. This is nothing I want to do manually, even though it could be a little less (<300) if I apply the 30% coupon for the jacket itself as well.
- Create a macro
    
    + The first thing is selecting the proper requests for a macro
    
    ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image7.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image7.png)
    
    + The POST to /cart does not contain a csrf-token, but the one to /cart/coupon does. So I modify the first request to /cart to redirect to CART so that the csrf-token for the next request can be extracted.
    
    + On the first test of the macro, redemption of the gift card failed as I forgot to change the gift card code to be taken from the previous request
    
    ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image8.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image8.png)
    
    + So manually redeeming the code on the website to obtain my $3, then changing the macro to obtain the value from the previous request.
    
    ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image9.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image9.png)
    
    + And the request to redeem the gift card needs to be updated to actually use that value
    
    ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image10.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image10.png)
    
    + Then retest again
    
- Automate it
    
    + Now the macro test is successful, the parameter is obtained automatically and the gift card is applied. So I create a session rule that runs this macro for every request
    
    ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image11.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image11.png)
    
    + Send a plain request to /my-account to Burp Intruder. I clear all payload positions and add one for null payloads. During testing, I obtained already some of the 412 gift cards required, but use that number nonetheless as the number of payloads generated.
    
    + In addition, the requests must be made in order, so I use a resource pool with only a single concurrent request
    
    ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image12.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image12.png)
    
    + Attack type: **Sniper**
    
    + Payload: Null payload, 412 times
    
    + While the attack is running, refreshing of the account page in the browser shows a steady increase in store credit. So let it run for a while...
    
    ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image13.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image13.png)
    
    + After it is finished, the cart looks much nicer for me and I can order. And I have no idea why I did not apply the discount code here, would have saved quite a number of calls.
    
    ![exploit%20e9358cc33e834f7da5a4bb8dd679df14/image14.png](exploit%20e9358cc33e834f7da5a4bb8dd679df14/image14.png)